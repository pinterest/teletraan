{% extends 'environs/env_base.html'%}
{% load utils %}

{% block breadcrumb-items %}
<ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/envs">Environments</a></li>
    <li><a href="/env/{{ env.envName }}/{{ env.stageName }}">{{ env.envName }} ({{ env.stageName }})</a></li>
    <li><a href="/env/{{ env.envName }}/{{ env.stageName }}/config">General Config</a></li>
    <li class="active">New Capacity</li>
</ul>
{% endblock %}
{% load static %}

{% block side-panel-actions %}
<script type="text/javascript" src="{% static "js/components/sharedcomponents.js"%}"></script>
<div class="panel panel-default" id="side-panel">
    <div class="panel-heading clearfix">
        <h4 class="panel-title pull-left">Capacity</h4>
    </div>
    <div class="row">
            <side-button styleclass="fa fa-gears" text="Advanced Settings" href="/env/{{ env.envName }}/{{ env.stageName }}/config/newcapacity/advanced/" title="Advanced Settings"></side-button>
    </div>
</div>
{% endblock %}

{% block new-builds-panel %}
{% endblock %}
{% block new-pred-deploys-panel %}
{% endblock %}

{% block main %}
{% if not basic_cluster_info|canReplaceCluster %}
    <div class="alert alert-info">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <strong>Warning!</strong> This environment stage has scheduled cluster rolling upgrade.
        You cannot update this page unless you cancel cluster replacement.
    </div>
{% endif %}

{% include "environs/env_tabs.tmpl" with envTabKind="config/capacity" %}
<script type="text/javascript" src="{% static "js/components/sharedcomponents.js"%}"></script>

<div class="panel panel-default" id="capacityPanel">
<div class="panel-heading clearfix">
    <h4 class="panel-title pull-left pointer-cursor">Basic Settings</h4>
</div>
<div id="envCapacityId" class="panel-body">
    <div class="container-fluid">
        <form id="envCapacityFormId" class="form-horizontal" role="form">
            <div class="row">
                <label>This is for CMP docker only hosts. For other type, click the Advanced Settings on the left</label>
            </div>
            <label-input label="Capacity" placeholder="# of instances" v-model="instanceCount"></label-input>
            <label-select label="Host Type" title="Compute Capability of the host" v-model="selectedHostTypeValue" v-bind:selectoptions="hostTypeOptions"></label-select>
            <label-select label="Security Zone" title="Security zone to control inbound/outboud traffic" v-model="selectedSecurityZoneValue" v-bind:selectoptions="securityZoneOptions"></label>
        </form>
    </div>
</div>
<modal v-bind:title="confirmDialogTitle" v-bind:id="confirmDialogId" v-on:input="clickDialog">
    <div slot="body">Are you sure to create a new host group for environment {{env.envName}}({{env.stageName}})?</div>
</modal>

<div class="panel-footer clearfix">
    <div class="pull-right">
        <button id="saveEnvCapacityBtnId" class="btn btn-primary" data-target="#createHostGroup" data-toggle="modal" 
            data-loading-text="Creating...">
            <span class="glyphicon glyphicon-floppy-save"></span> Create
        </button>
    </div>
</div>
</div>


<script>
var capacityView = new Vue({
    el:"#side-panel",
 }
)

var capacityCreationInfo = {{capacity_creation_info|safe}}

var capacitySetting = new Vue({
    el:"#capacityPanel",
    data:{
        confirmDialogTitle:"Confirm New Capacity Creation",
        confirmDialogId:"createHostGroup",
        instanceCount:"",
        selectedHostTypeValue: capacityCreationInfo.hostTypes[0].abstract_name,
        selectedSecurityZoneValue: capacityCreationInfo.securityZones[0].abstract_name,
        hostTypeOptions: capacityCreationInfo.hostTypes.map(function(item,idx){return {value:item.abstract_name,text:item.abstract_name+" ("+item.core+" cores, "+item.mem+" GB, "+item.storage+")"}}),
        securityZoneOptions:capacityCreationInfo.securityZones.map(function(item,idx){return {value:item.abstract_name, text:item.abstract_name+" ("+item.description+")"}}),
    },
    methods:{
        'validateInput': function(clusterInfo){
            //Validate input data. 
            var count = clusterInfo['capacity']
            if (count === undefined || count === null || isNaN(count) || count<=0 || count>1000 ) {
                // do something
                globalNotificationBanner.error = "Capacity must be a number between 0 and 1000"
                return false 
            }
            return true
        },
        'getDefaultPlacement': function(securityZones){
            //This function set the default 
            //placements based on security zones
            var mappings = capacityCreationInfo.defaultMappings[this.selectedSecurityZoneValue]
            var placements = capacityCreationInfo.placements.filter(function(item){return $.inArray(item.abstract_name,mappings)>=0;})
            var sorted = placements.sort(function(item1,item2){return item1.capacity<item2.capacity;})

            //Returnt the top 3 of capacity
            return sorted.map(function(item){return item.abstract_name;}).slice(0,3).join(',')
        },
        'getDefaultBaseImage': function(){
            var sorted = capacityCreationInfo.baseImages.sort(function(item1,item2){
                return item1.publish_date>item2.publish_data;})

            return sorted[0].id;
        },
        'sendRequest':function(clusterInfo){
                $.ajax({
                    type: 'POST',
                    url: '/env/{{ env.envName }}/{{ env.stageName }}/config/newcapacity/',
                    data: JSON.stringify(clusterInfo),
                    dataType: "json",
                    beforeSend: function(xhr, settings) {
                        var csrftoken = getCookie('csrftoken')
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    
                    },
                    success: function (data) {
                        globalNotificationBanner.info = "Request sent successfully"    
                    },
                    error: function (data) {
                        globalNotificationBanner.error = data
                    }
            });
        },
        'createCapacity':function(){
                //Create the default capacity. The input here aligns to the Rodimus new cluster 
            var clusterInfo = {};
            clusterInfo['provider'] = capacityCreationInfo['defaultProvider'];
            clusterInfo['capacity'] = Number(this.instanceCount);
            clusterInfo['baseImageId'] = this.getDefaultBaseImage();
            clusterInfo['hostType'] = this.selectedHostTypeValue;
            clusterInfo['securityZone'] = this.selectedSecurityZoneValue;
            clusterInfo['placement'] = this.getDefaultPlacement();
            clusterInfo['configs'] = capacityCreationInfo['defaultCMPConfigs']
            
            if (this.validateInput(clusterInfo)){
                //Send request
                this.sendRequest(clusterInfo);
            }
        },
        "clickDialog":function(value){
            if (value){
                this.createCapacity();
            }
        }
    }
 }
)


</script>

{% endblock %}

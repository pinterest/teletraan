<div id="stageFilter" class="dropdown" style="float:right;">
    <button
        id="stageFilterButton"
        class="deployToolTip dropdown-toggle btn btn-default"
        type="button"
        data-toggle="dropdown"
        title="Filter environmnent stages by stage type">
            <span class="glyphicon glyphicon-filter"/>
    </button>
    <ul class="dropdown-menu checkbox-menu allow-focus" style="left: unset; right: 0px;">
   {% for stage in all_stage_types %}
        <li >
            <label onclick="event.stopPropagation()">
                <input data-stagetype="{{stage}}" type="checkbox"/>
                <span>{{stage|title}}</span>
            </label>
        </li>
    {% endfor %}
    <div class="divider"></div>
    <button class="btn btn-default stage-filter-reset-button" onclick="resetFilter()">Reset</button>
   </ul>
</div>
<ul id="stage-tabs" class="nav nav-tabs" style="padding-right:40px;">
   {% for stage in envs %}
    <!-- TODO: add filter ui component here -->
        <li data-stagetype="{{stage.stageType}}" {% if stage.stageName == env.stageName %}class="active"{% endif %}>
            <a class="deployToolTip" data-container="body" data-toggle="tooltip" title="{{stage.description}}" data-placement="bottom"
            onclick="callback(event, this)"
            href="/env/{{ env.envName }}/{{ stage.stageName }}/{{ envTabKind }}">{{ stage.stageName }}</a>
        </li>
    {% endfor %}
</ul>
<div id="filter-opts" data-filter="{{stagetype_filter}}" />



<script>
    let filter;
    let filterInactive = true;

    try {
        filter = Array.from(JSON.parse(decodeURIComponent($("#filter-opts").attr("data-filter"))));
        if(!Array.isArray(filter)){
            throw new Error("invalid url filter params");
        }
        filterInactive = filter.length === 0;
    } catch {
        filter = [];
    }

   $('#stageFilter').on("change", "input[type='checkbox']", function() {
        $(this).closest("li").toggleClass("active", this.checked);


        let stageType = $(this).attr("data-stagetype");
        if(this.checked){
            filter.push(stageType);
        } else {
            //remove from filter
            let index = filter.indexOf(stageType);
            if(index > -1){
                filter.splice(index, 1);
            }
        }
        //turn filter off if empty
        if(filter.length < 1){
            filterInactive=true;
        } else {
            filterInactive=false;
        }

        runFilter();
    });

    if(!filterInactive){
        updateChecklist();
        runFilter();
    }


    //set tabs visible by filter
    function runFilter(){
         $("#stage-tabs").children().each(function() {
            let stageType = $(this).attr("data-stagetype");
            if(filter.includes(stageType) || filterInactive){
                this.style.display = "block";
            } else {
                this.style.display = "none";
            }
        })

        /// styling to button based on filter active or not
        $("#stageFilterButton").toggleClass("btn-primary", !filterInactive);
        updateUrl();
    }

    //uncheck all filter boxes and turn filter off
    function resetFilter(){
        filter=[];
        $('#stageFilter > ul').children().each(function() {
            $(this).removeClass("active");
            $(this).find("input:first").prop("checked", false);
        })
        filterInactive=true;
        runFilter();
    }

    function updateChecklist(){
        $('#stageFilter > ul').children().each(function() {
            let k = $(this).find("input:first");
            if(filter.includes(k.attr("data-stagetype"))){
                k.prop("checked", true);
                $(this).addClass("active");
            }
        })
    }

    //update filter param in url as it changes
    function updateUrl(){
        let url = new URL(window.location.href);
        if(filter.length < 1){
            url.searchParams.delete("stageFilter");
        } else {
            url.searchParams.set("stageFilter", JSON.stringify(filter));
        }
            window.history.replaceState(null,null,url);
    }

    //intercept and add filter parameter to link
    function callback(e, anchor){
        if(!filterInactive){
            e.preventDefault();
            let url = new URL(anchor.href);
            url.searchParams.set("stageFilter", JSON.stringify(filter));
            window.location.href=url;
        }
    }
</script>

